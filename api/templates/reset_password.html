{% load static %}
{% load my_filters %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>비밀번호 재설정_【MDeskWeb】</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-neo.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/style.css' %}">
    <style>
        * {
            font-family: 'NanumSquareNeo', 'Nanum Square Neo', sans-serif !important;
        }
    </style>
</head>
<body>
 
<div class="login-main">
    <header class="layui-elip" style="width: 82%">비밀번호 재설정</header>
 
    <form class="layui-form">
        <div class="layui-input-inline">
            <div class="layui-inline" style="width: 85%">
                <input type="password" id="pwd" name="password" required lay-verify="required" lay-reqtext="비밀번호를 입력해주세요" placeholder="새 비밀번호를 입력하세요" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-inline">
                <i class="layui-icon" id="pri" style="color: green;font-weight: bolder;" hidden></i>
            </div>
            <div class="layui-inline">
                <i class="layui-icon" id="pwr" style="color: red; font-weight: bolder;" hidden>ဆ</i>
            </div>
        </div>
        
        <div class="layui-input-inline">
            <div class="layui-inline" style="width: 85%">
                <input type="password" id="rpwd" name="repassword" required lay-verify="required" lay-reqtext="비밀번호를 다시 입력해주세요" placeholder="새 비밀번호를 다시 입력하세요" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-inline">
                <i class="layui-icon" id="rpri" style="color: green;font-weight: bolder;" hidden></i>
            </div>
            <div class="layui-inline">
                <i class="layui-icon" id="rpwr" style="color: red; font-weight: bolder;" hidden>ဆ</i>
            </div>
        </div>
 
        <div class="layui-input-inline login-btn" style="width: 85%">
            <button type="submit" lay-submit lay-filter="reset" class="layui-btn">비밀번호 재설정</button>
        </div>
        <hr style="width: 85%" />
        <p style="width: 85%"><a href="/api/user_action?action=login" class="fl">로그인</a></p>
    </form>
</div>
 
 
<script src={% static "layui/layui.js" %}></script>
<script type="text/javascript">
    layui.use(['form','jquery','layer'], function () {
        var form   = layui.form;
        var $      = layui.jquery;
        var layer  = layui.layer;
        
        // 비밀번호 유효성 검사
        $('#pwd').blur(function() {
            var reg = /^[\w\S]{8,20}$/;
            if(!($('#pwd').val().match(reg))){
                $('#pwr').removeAttr('hidden');
                $('#pri').attr('hidden','hidden');
                layer.msg('8~20자리 비밀번호를 입력하세요. 영문, 숫자, 특수문자를 포함할 수 있습니다.');
            }else {
                $('#pri').removeAttr('hidden');
                $('#pwr').attr('hidden','hidden');
            }
        });
        
        // 비밀번호 일치 확인
        $('#rpwd').blur(function() {
            if($('#pwd').val() != $('#rpwd').val()){
                $('#rpwr').removeAttr('hidden');
                $('#rpri').attr('hidden','hidden');
                layer.msg('비밀번호가 일치하지 않습니다!');
            }else {
                $('#rpri').removeAttr('hidden');
                $('#rpwr').attr('hidden','hidden');
            }
        });
        
        // 비밀번호 재설정 제출
        form.on('submit(reset)', function() {
            var urlParams = new URLSearchParams(window.location.search);
            var token = urlParams.get('token');
            
            if(!token){
                layer.msg('유효하지 않은 링크입니다.');
                return false;
            }
            
            if($('#pwd').val() != $('#rpwd').val()){
                layer.msg('비밀번호가 일치하지 않습니다!');
                return false;
            }
            
            $.ajax({
                url:'/api/user_action?action=reset_password',
                type:'post',
                dataType:'json',
                data:{
                    token: token,
                    password: $('#pwd').val()
                },
                success:function(resp){
                    if (resp.code == 1) {
                        layer.alert(resp.msg, {
                            icon: 1,
                            title: '알림',
                            btn: ['확인']
                        }, function(index){
                            location.href = '/api/user_action?action=login';
                        });
                    }else {
                        layer.msg(resp.msg);
                    }
                }
            });
            return false;
        });
 
    });
</script>
</body>
</html>

