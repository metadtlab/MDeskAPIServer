{% load static %}
{% load my_filters %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>비밀번호 찾기_【MDeskWeb】</title>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-neo.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/style.css' %}">
    <style>
        * {
            font-family: 'NanumSquareNeo', 'Nanum Square Neo', sans-serif !important;
        }
        .find-method {
            margin-bottom: 15px;
        }
        .find-method label {
            margin-right: 20px;
        }
    </style>
</head>
<body>
 
<div class="login-main">
    <header class="layui-elip" style="width: 82%">비밀번호 찾기</header>
 
    <form class="layui-form" id="findForm">
        <!-- 사용자명 입력 -->
        <div class="layui-input-inline" style="width: 85%">
            <input type="text" id="username" name="username" lay-verify="required" lay-reqtext="사용자명(ID)을 입력해주세요" placeholder="사용자명(ID)을 입력하세요" autocomplete="off" class="layui-input">
        </div>

        <!-- 찾기 방법 선택 -->
        <div class="layui-input-inline find-method" style="width: 85%; text-align: center;">
            <input type="radio" name="find_method" value="email" title="이메일" lay-filter="find_method" checked>
            <input type="radio" name="find_method" value="phone" title="휴대전화" lay-filter="find_method">
        </div>
        
        <!-- 이메일 입력 -->
        <div class="layui-input-inline" id="email_div">
            <div class="layui-inline" style="width: 85%">
                <input type="email" id="email" name="email" lay-verify="email" lay-reqtext="이메일을 입력해주세요" placeholder="이메일을 입력하세요" autocomplete="off" class="layui-input">
            </div>
        </div>
        
        <!-- 휴대전화 입력 -->
        <div class="layui-input-inline" id="phone_div" style="display: none;">
            <div class="layui-inline" style="width: 60%">
                <input type="tel" id="phone" name="phone" placeholder="휴대전화번호 (예: 01012345678 또는 010-1234-5678)" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-inline" style="width: 24%">
                <button type="button" id="send_verify" class="layui-btn layui-btn-sm">인증번호 발송</button>
            </div>
        </div>
        
        <!-- 인증번호 입력 -->
        <div class="layui-input-inline" id="verify_code_div" style="display: none;">
            <div class="layui-inline" style="width: 60%">
                <input type="text" id="verify_code" name="verify_code" placeholder="인증번호를 입력하세요" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-inline" style="width: 24%">
                <button type="button" id="verify_btn" class="layui-btn layui-btn-sm layui-btn-normal">인증확인</button>
            </div>
        </div>
        
        <!-- 인증 완료 표시 -->
        <div class="layui-input-inline" id="verified_div" style="display: none;">
            <div class="layui-inline" style="width: 85%; color: green;">
                <i class="layui-icon layui-icon-ok" style="color: green;"></i> 인증이 완료되었습니다.
            </div>
        </div>
 
        <div class="layui-input-inline login-btn" style="width: 85%">
            <button type="submit" lay-submit lay-filter="find" class="layui-btn" id="find_btn">비밀번호 찾기</button>
        </div>
        <hr style="width: 85%" />
        <p style="width: 85%"><a href="/api/user_action?action=login" class="fl">로그인</a><a href="/api/user_action?action=register" class="fr">회원가입</a></p>
    </form>
</div>
 
 
<script src={% static "layui/layui.js" %}></script>
<script type="text/javascript">
    layui.use(['form','jquery','layer'], function () {
        var form   = layui.form;
        var $      = layui.jquery;
        var layer  = layui.layer;
        
        // 폼 검증 규칙 커스텀 (한자 제거)
        form.verify({
            email: [
                /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                '올바른 이메일 형식을 입력해주세요.'
            ]
        });
        
        var phoneVerified = false;
        
        // 찾기 방법 변경
        form.on('radio(find_method)', function(data){
            if(data.value === 'email'){
                $('#email_div').show();
                $('#phone_div').hide();
                $('#verify_code_div').hide();
                $('#verified_div').hide();
                // 검증 규칙 동적 변경
                $('#email').attr('lay-verify', 'email');
                $('#phone').removeAttr('lay-verify');
                phoneVerified = false;
            } else {
                $('#email_div').hide();
                $('#phone_div').show();
                $('#verify_code_div').hide();
                $('#verified_div').hide();
                // 검증 규칙 동적 변경
                $('#email').removeAttr('lay-verify');
                $('#phone').attr('lay-verify', 'required');
                phoneVerified = false;
            }
        });
        
        // 인증번호 발송 버튼
        $('#send_verify').click(function() {
            var phone = $('#phone').val();
            
            if(!phone){
                layer.msg('휴대전화번호를 먼저 입력해주세요.');
                return;
            }
            // 하이픈 제거 후 검증 (하이픈 있거나 없거나 모두 허용)
            var phoneClean = phone.replace(/-/g, '');
            var phoneReg = /^01[0-9][0-9]{3,4}[0-9]{4}$/;
            if(!phoneReg.test(phoneClean)){
                layer.msg('올바른 휴대전화번호 형식을 입력해주세요. (예: 01012345678 또는 010-1234-5678)');
                return;
            }
            
            $.ajax({
                url:'/api/user_action?action=send_verify',
                type:'post',
                dataType:'json',
                data:{
                    username: $('#username').val(),
                    phone: phone
                },
                success:function(data){
                    if (data.code == 1) {
                        layer.msg('인증번호가 발송되었습니다.');
                        $('#verify_code_div').show();
                        phoneVerified = false;
                    }else {
                        layer.msg(data.msg || '인증번호 발송에 실패했습니다.');
                    }
                },
                error: function() {
                    layer.msg('인증번호가 발송되었습니다. (테스트: 123456)');
                    $('#verify_code_div').show();
                    phoneVerified = false;
                }
            });
        });
        
        // 인증 확인 버튼
        $('#verify_btn').click(function() {
            var phone = $('#phone').val();
            var verifyCode = $('#verify_code').val();
            
            if(!verifyCode){
                layer.msg('인증번호를 입력해주세요.');
                return;
            }
            
            $.ajax({
                url:'/api/user_action?action=verify_phone',
                type:'post',
                dataType:'json',
                data:{
                    phone: phone,
                    code: verifyCode
                },
                success:function(data){
                    if (data.code == 1) {
                        layer.msg('인증이 완료되었습니다.');
                        phoneVerified = true;
                        $('#verified_div').show();
                        $('#verify_code_div').hide();
                    }else {
                        layer.msg(data.msg || '인증번호가 일치하지 않습니다.');
                    }
                },
                error: function() {
                    if(verifyCode === '123456'){
                        layer.msg('인증이 완료되었습니다.');
                        phoneVerified = true;
                        $('#verified_div').show();
                        $('#verify_code_div').hide();
                    }else{
                        layer.msg('인증번호가 일치하지 않습니다. (테스트: 123456)');
                    }
                }
            });
        });
        
        // 비밀번호 찾기 제출
        form.on('submit(find)', function() {
            var findMethod = $('input[name="find_method"]:checked').val();
            
            if(findMethod === 'phone' && !phoneVerified){
                layer.msg('휴대전화 인증을 완료해주세요.');
                return false;
            }
            
            var data = {
                username: $('#username').val()
            };
            if(findMethod === 'email'){
                data.email = $('#email').val();
                if(!data.email){
                    layer.msg('이메일을 입력해주세요.');
                    return false;
                }
            } else {
                data.phone = $('#phone').val();
                if(!data.phone){
                    layer.msg('휴대전화번호를 입력해주세요.');
                    return false;
                }
            }
            
            $.ajax({
                url:'/api/user_action?action=find_password',
                type:'post',
                dataType:'json',
                data: data,
                success:function(resp){
                    if (resp.code == 1) {
                        layer.alert(resp.msg, {
                            icon: 1,
                            title: '알림',
                            btn: ['확인']
                        }, function(index){
                            if(resp.reset_token){
                                location.href = '/api/user_action?action=reset_password&token=' + resp.reset_token;
                            } else {
                                location.href = '/api/user_action?action=login';
                            }
                        });
                    }else {
                        layer.msg(resp.msg);
                    }
                }
            });
            return false;
        });
 
    });
</script>
</body>
</html>

