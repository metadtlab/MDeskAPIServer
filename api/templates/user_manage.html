{% extends "base.html" %}
{% load static %}
{% load my_filters %}
{% block title %}사용자관리{% endblock %}
{% block legend_name %}사용자관리{% endblock %}
{% block content %}
<div style="padding: 20px; background-color: #F2F2F2;">
  <div class="layui-row layui-col-space15">
    <!-- 좌측: 사용자 등록/수정 폼 -->
    <div class="layui-col-md5">
      <div class="layui-card">
        <div class="layui-card-header">
          <i class="layui-icon layui-icon-{% if edit_user %}edit{% else %}add-circle{% endif %}"></i>
          {% if edit_user %}사용자 수정{% else %}새 사용자 등록{% endif %}
        </div>
        <div class="layui-card-body">
          <form class="layui-form" id="userForm">
            <input type="hidden" id="user_id" name="user_id" value="{% if edit_user %}{{edit_user.id}}{% endif %}">
            
            <div class="layui-form-item">
              <label class="layui-form-label">사용자명 <span style="color:red;">*</span></label>
              <div class="layui-input-block">
                <input type="text" id="username" name="username" value="{% if edit_user %}{{edit_user.username}}{% endif %}" {% if edit_user %}disabled{% else %}lay-verify="required"{% endif %} placeholder="사용자명을 입력하세요" autocomplete="off" class="layui-input">
                {% if edit_user %}
                <div class="layui-form-mid layui-word-aux">사용자명은 변경할 수 없습니다.</div>
                {% endif %}
              </div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">{% if edit_user %}새 비밀번호{% else %}비밀번호 <span style="color:red;">*</span>{% endif %}</label>
              <div class="layui-input-block">
                <input type="password" id="new_password" name="new_password" {% if not edit_user %}lay-verify="required"{% endif %} placeholder="{% if edit_user %}변경하려면 입력 (8~20자){% else %}비밀번호 입력 (8~20자){% endif %}" autocomplete="off" class="layui-input">
              </div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">회사명</label>
              <div class="layui-input-inline" style="width: 280px;">
                <input type="text" id="company_name" name="company_name" value="{% if edit_user %}{{edit_user.company_name}}{% endif %}" placeholder="회사명 직접 입력" autocomplete="off" class="layui-input">
              </div>
              <div class="layui-input-inline" style="width: 180px;">
                <select id="company_select" lay-filter="companySelect">
                  <option value="">-- 그룹 선택 --</option>
                  {% for group in groups %}
                  <option value="{{group.id}}" data-company="{{group.company_name}}" {% if edit_user and edit_user.group_id == group.id %}selected{% endif %}>{{group.company_name}}</option>
                  {% endfor %}
                </select>
              </div>
              <input type="hidden" id="group_id" name="group_id" value="{% if edit_user.group_id %}{{edit_user.group_id}}{% endif %}">
              <div class="layui-form-mid layui-word-aux" style="padding-left: 0;">그룹에서 선택 가능</div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">이메일</label>
              <div class="layui-input-block">
                <input type="email" id="email" name="email" value="{% if edit_user %}{{edit_user.email}}{% endif %}" placeholder="이메일" autocomplete="off" class="layui-input">
              </div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">휴대전화</label>
              <div class="layui-input-block">
                <input type="tel" id="phone" name="phone" value="{% if edit_user %}{{edit_user.phone}}{% endif %}" placeholder="휴대전화번호" autocomplete="off" class="layui-input">
              </div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">회원등급</label>
              <div class="layui-input-block">
                <select id="membership_level" name="membership_level">
                  <option value="free" {% if edit_user.membership_level == 'free' %}selected{% endif %}>무료</option>
                  <option value="basic" {% if edit_user.membership_level == 'basic' %}selected{% endif %}>기본</option>
                  <option value="standard" {% if edit_user.membership_level == 'standard' %}selected{% endif %}>스탠다드</option>
                  <option value="premium" {% if edit_user.membership_level == 'premium' %}selected{% endif %}>프리미엄</option>
                  <option value="enterprise" {% if edit_user.membership_level == 'enterprise' %}selected{% endif %}>엔터프라이즈</option>
                </select>
              </div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">최대 상담원</label>
              <div class="layui-input-block">
                <input type="number" id="max_agents" name="max_agents" value="{% if edit_user %}{{edit_user.max_agents}}{% else %}3{% endif %}" min="1" max="100" class="layui-input">
              </div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">상태</label>
              <div class="layui-input-block">
                <input type="checkbox" id="is_active" name="is_active" lay-skin="switch" lay-text="활성|비활성" {% if edit_user.is_active or not edit_user %}checked{% endif %}>
              </div>
            </div>
            
            <div class="layui-form-item">
              <label class="layui-form-label">관리자 권한</label>
              <div class="layui-input-block">
                <input type="checkbox" id="is_admin" name="is_admin" lay-skin="switch" lay-text="관리자|일반" {% if edit_user.is_admin %}checked{% endif %}>
              </div>
            </div>
            
            <div class="layui-form-item">
              <div class="layui-input-block">
                <button type="submit" lay-submit lay-filter="saveUser" class="layui-btn">
                  <i class="layui-icon layui-icon-ok"></i> {% if edit_user %}수정{% else %}등록{% endif %}
                </button>
                {% if edit_user %}
                <a href="/api/user_manage" class="layui-btn layui-btn-primary">
                  <i class="layui-icon layui-icon-return"></i> 취소
                </a>
                {% else %}
                <button type="reset" class="layui-btn layui-btn-primary">
                  <i class="layui-icon layui-icon-refresh"></i> 초기화
                </button>
                {% endif %}
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- 우측: 사용자 목록 -->
    <div class="layui-col-md7">
      <div class="layui-card">
        <div class="layui-card-header">
          <i class="layui-icon layui-icon-user"></i>
          사용자 목록 (총 {{users|length}}명)
        </div>
        <div class="layui-card-body" style="padding: 0;">
          <table class="layui-table" lay-skin="line" style="margin: 0;">
            <colgroup>
              <col width="20%">
              <col width="20%">
              <col width="15%">
              <col width="15%">
              <col width="30%">
            </colgroup>
            <thead>
              <tr>
                <th>사용자명</th>
                <th>회사명</th>
                <th>등급</th>
                <th>상태</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr style="{% if not user.is_active %}background-color: #f5f5f5; color: #999;{% endif %}">
                <td>
                  <strong>{{user.username}}</strong>
                  {% if user.is_superuser %}
                  <span class="layui-badge layui-bg-red" style="margin-left: 5px;">최고관리자</span>
                  {% elif user.is_admin %}
                  <span class="layui-badge layui-bg-blue" style="margin-left: 5px;">관리자</span>
                  {% endif %}
                </td>
                <td>{{user.company_name|default:"-"}}</td>
                <td>
                  {% if user.membership_level == 'free' %}무료
                  {% elif user.membership_level == 'basic' %}기본
                  {% elif user.membership_level == 'standard' %}스탠다드
                  {% elif user.membership_level == 'premium' %}프리미엄
                  {% elif user.membership_level == 'enterprise' %}엔터프라이즈
                  {% else %}{{user.membership_level}}
                  {% endif %}
                </td>
                <td>
                  {% if user.is_active %}
                  <span class="layui-badge layui-bg-green">활성</span>
                  {% else %}
                  <span class="layui-badge layui-bg-gray">비활성</span>
                  {% endif %}
                </td>
                <td>
                  <a href="/api/user_manage?edit={{user.id}}" class="layui-btn layui-btn-xs layui-btn-normal">
                    <i class="layui-icon layui-icon-edit"></i> 수정
                  </a>
                  {% if not user.is_superuser %}
                  <button type="button" class="layui-btn layui-btn-xs {% if user.is_admin %}layui-btn-warm{% else %}layui-btn-primary{% endif %}" onclick="toggleAdmin({{user.id}}, '{{user.username}}', {{user.is_admin|yesno:'true,false'}})">
                    <i class="layui-icon layui-icon-{% if user.is_admin %}release{% else %}auz{% endif %}"></i>
                  </button>
                  {% if user.is_active %}
                  <button type="button" class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteUser({{user.id}}, '{{user.username}}')">
                    <i class="layui-icon layui-icon-delete"></i>
                  </button>
                  {% endif %}
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" style="text-align: center; color: #999; padding: 40px;">
                  <i class="layui-icon layui-icon-face-surprised" style="font-size: 40px;"></i>
                  <br><br>등록된 사용자가 없습니다.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
    var isSubmitting = false;
    
    layui.use(['form','jquery','layer'], function () {
        var form   = layui.form;
        var $      = layui.jquery;
        var layer  = layui.layer;
        
        // 폼 검증 규칙 커스텀 (한자 제거)
        form.verify({
            email: [
                /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                '올바른 이메일 형식을 입력해주세요.'
            ]
        });
        
        // 폼 렌더링 (select 등)
        form.render();
        
        // 페이지 로드 시 저장된 group_id가 있으면 select 초기 선택
        var savedGroupId = $('#group_id').val();
        if (savedGroupId) {
            $('#company_select').val(savedGroupId);
            form.render('select');
        }
        
        // 그룹 선택 시 회사명과 그룹ID 자동 입력
        form.on('select(companySelect)', function(data) {
            if (data.value) {
                // 선택된 옵션의 data-company 속성에서 회사명 가져오기
                var companyName = $(data.elem).find('option:selected').data('company');
                $('#company_name').val(companyName || '');
                $('#group_id').val(data.value);
            } else {
                // 선택 해제 시 그룹ID 초기화 (회사명은 직접 입력 가능하도록 유지)
                $('#group_id').val('');
            }
        });
        
        // 네이티브 select 변경 이벤트도 바인딩 (백업)
        $('#company_select').on('change', function() {
            var selectedValue = $(this).val();
            if (selectedValue) {
                var companyName = $(this).find('option:selected').data('company');
                $('#company_name').val(companyName || '');
                $('#group_id').val(selectedValue);
            } else {
                $('#group_id').val('');
            }
        });
        
        // 폼 제출
        form.on('submit(saveUser)', function(data) {
            if (isSubmitting) return false;
            isSubmitting = true;
            
            $('button[lay-filter="saveUser"]').prop('disabled', true).addClass('layui-btn-disabled');
            
            $.ajax({
                url: '/api/user_manage/save',
                type: 'POST',
                dataType: 'json',
                data: {
                    user_id: $('#user_id').val(),
                    username: $('#username').val(),
                    new_password: $('#new_password').val(),
                    company_name: $('#company_name').val(),
                    group_id: $('#group_id').val(),
                    email: $('#email').val(),
                    phone: $('#phone').val(),
                    membership_level: $('#membership_level').val(),
                    max_agents: $('#max_agents').val(),
                    is_active: $('#is_active').is(':checked') ? '1' : '0',
                    is_admin: $('#is_admin').is(':checked') ? '1' : '0'
                },
                success: function(resp) {
                    if (resp.code == 1) {
                        layer.msg(resp.msg, {icon: 1, time: 1500}, function() {
                            location.href = '/api/user_manage';
                        });
                    } else {
                        layer.msg(resp.msg, {icon: 2});
                        isSubmitting = false;
                        $('button[lay-filter="saveUser"]').prop('disabled', false).removeClass('layui-btn-disabled');
                    }
                },
                error: function() {
                    layer.msg('요청 중 오류가 발생했습니다.', {icon: 2});
                    isSubmitting = false;
                    $('button[lay-filter="saveUser"]').prop('disabled', false).removeClass('layui-btn-disabled');
                }
            });
            return false;
        });
    });
    
    // 관리자 권한 토글
    function toggleAdmin(userId, username, isAdmin) {
        var newStatus = isAdmin ? '일반 사용자' : '관리자';
        layui.use('layer', function() {
            var layer = layui.layer;
            layer.confirm('<strong>' + username + '</strong>님을 <strong>' + newStatus + '</strong>로 변경하시겠습니까?', {
                title: '권한 변경 확인',
                btn: ['변경', '취소']
            }, function(index) {
                layui.jquery.ajax({
                    url: '/api/user_manage/toggle_admin/' + userId,
                    type: 'POST',
                    dataType: 'json',
                    success: function(resp) {
                        layer.close(index);
                        if (resp.code == 1) {
                            layer.msg(resp.msg, {icon: 1, time: 1500}, function() {
                                location.reload();
                            });
                        } else {
                            layer.msg(resp.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('요청 중 오류가 발생했습니다.', {icon: 2});
                    }
                });
            });
        });
    }
    
    // 사용자 비활성화
    function deleteUser(userId, username) {
        layui.use('layer', function() {
            var layer = layui.layer;
            layer.confirm('<strong>' + username + '</strong> 사용자를 비활성화하시겠습니까?<br><br><span style="color: #999;">비활성화된 사용자는 로그인할 수 없습니다.</span>', {
                title: '사용자 비활성화 확인',
                btn: ['비활성화', '취소']
            }, function(index) {
                layui.jquery.ajax({
                    url: '/api/user_manage/delete/' + userId,
                    type: 'POST',
                    dataType: 'json',
                    success: function(resp) {
                        layer.close(index);
                        if (resp.code == 1) {
                            layer.msg(resp.msg, {icon: 1, time: 1500}, function() {
                                location.reload();
                            });
                        } else {
                            layer.msg(resp.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('요청 중 오류가 발생했습니다.', {icon: 2});
                    }
                });
            });
        });
    }
</script>
{% endblock %}

